<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Paragon MNIST — WASM (28×28 → 256 → 10)</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="wasm_exec.js"></script>
    <style>
      :root {
        color-scheme: dark;
      }
      body {
        margin: 24px;
        font: 14px/1.5 ui-monospace, Menlo, Consolas, monospace;
        background: #0b0c0f;
        color: #e6e7eb;
      }
      h1 {
        margin: 0 0 14px;
        font-size: 20px;
      }
      .card {
        background: #151821;
        border: 1px solid #222737;
        border-radius: 10px;
        padding: 14px;
        max-width: 900px;
      }
      .row {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
        margin: 10px 0;
      }
      input,
      button,
      select {
        font: inherit;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid #2a3042;
        background: #1a1f2d;
        color: #e6e7eb;
      }
      button {
        cursor: pointer;
      }
      button:hover {
        background: #20273a;
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }
      .pill {
        padding: 3px 8px;
        border-radius: 999px;
        font-size: 12px;
        border: 1px solid transparent;
      }
      .ok {
        background: #064e3b;
        color: #c7f9e5;
        border-color: #0a6d54;
      }
      .warn {
        background: #3b2f06;
        color: #ffe9a8;
        border-color: #6d5a0a;
      }
      .err {
        background: #5a1016;
        color: #ffd0d4;
        border-color: #8b1f28;
      }
      .k {
        color: #9aa4b2;
      }
      pre {
        white-space: pre-wrap;
        background: #0d0f14;
        border: 1px solid #1f2433;
        border-radius: 8px;
        padding: 10px;
        max-height: 280px;
        overflow: auto;
      }
      .digits button {
        width: 32px;
      }
      .stat {
        min-width: 180px;
        background: #0d0f14;
        border: 1px solid #1f2433;
        border-radius: 8px;
        padding: 8px;
      }
      .label {
        font-size: 12px;
        color: #9aa4b2;
      }
      .val {
        font-weight: 700;
        margin-top: 2px;
      }
      .flex1 {
        flex: 1 1 auto;
      }
    </style>
  </head>
  <body>
    <canvas id="canvas" width="28" height="28" style="display: none"></canvas>
    <div class="card">
      <h1>Paragon MNIST — WASM (28×28 → 256 → 10)</h1>

      <div class="row">
        <span class="k">WASM:</span>
        <span id="wasmPill" class="pill warn">loading…</span>
        <span class="k">Net:</span> <span id="netPill" class="pill">—</span>
        <span class="k">Weights:</span> <span id="wPill" class="pill">—</span>
      </div>

      <div class="row">
        <button id="btnCreate">Create MNIST net</button>
        <button id="btnPerturb" disabled>Perturb weights</button>
      </div>

      <div class="row">
        <input id="modelUrl" size="42" value="http://127.0.0.1:8001/model" />
        <button id="btnImport" disabled>Fetch & Replace Weights</button>
      </div>

      <div class="row">
        <input id="svc" size="28" value="http://127.0.0.1:8001" />
        <div class="digits">
          <button data-digit="0" disabled>0</button
          ><button data-digit="1" disabled>1</button>
          <button data-digit="2" disabled>2</button
          ><button data-digit="3" disabled>3</button>
          <button data-digit="4" disabled>4</button
          ><button data-digit="5" disabled>5</button>
          <button data-digit="6" disabled>6</button
          ><button data-digit="7" disabled>7</button>
          <button data-digit="8" disabled>8</button
          ><button data-digit="9" disabled>9</button>
        </div>
      </div>

      <div class="row">
        <div class="stat">
          <div class="label">Predicted</div>
          <div id="pred" class="val">—</div>
        </div>
        <div class="stat">
          <div class="label">Confidence</div>
          <div id="conf" class="val">—</div>
        </div>
        <div class="stat">
          <div class="label">Latency</div>
          <div id="lat" class="val">—</div>
        </div>
      </div>

      <pre id="log">Loading…</pre>
    </div>

    <script>
      const $ = (id) => document.getElementById(id);
      const wasmPill = $("wasmPill"),
        netPill = $("netPill"),
        wPill = $("wPill");
      const btnCreate = $("btnCreate"),
        btnPerturb = $("btnPerturb");
      const btnImport = $("btnImport"),
        modelUrl = $("modelUrl");
      const svc = $("svc"),
        logEl = $("log"),
        predEl = $("pred"),
        confEl = $("conf"),
        latEl = $("lat");

      const setPill = (el, text, cls) => {
        el.textContent = text;
        el.className = "pill " + (cls || "");
      };
      const log = (x) =>
        (logEl.textContent =
          typeof x === "string" ? x : JSON.stringify(x, null, 2));
      const softmax = (xs) => {
        const nums = xs.map(Number);
        const m = Math.max(...nums);
        const exps = nums.map((v) => Math.exp(v - m));
        const s = exps.reduce((a, b) => a + b, 0) || 1;
        return exps.map((e) => e / s);
      };
      const argsJSON = (...a) => JSON.stringify(a);

      // WASM setup
      const go = new Go();
      let NewNetworkFloat32 = null;
      let net = null;

      (async function init() {
        try {
          const buf = await (await fetch("paragon.wasm")).arrayBuffer();
          const mod = await WebAssembly.instantiate(buf, go.importObject);
          go.run(mod.instance);
          NewNetworkFloat32 = self.NewNetworkFloat32;
          if (!NewNetworkFloat32) throw new Error("NewNetworkFloat32 missing");
          setPill(wasmPill, "ready", "ok");
          log("✅ WASM initialized.");
        } catch (e) {
          setPill(wasmPill, "error", "err");
          log(e?.stack || e);
        }
      })();

      // Create network (28×28→256→10) matching backend
      btnCreate.onclick = () => {
        try {
          const L = JSON.stringify([
            { Width: 28, Height: 28 },
            { Width: 256, Height: 1 },
            { Width: 10, Height: 1 },
          ]);
          const A = JSON.stringify(["linear", "relu", "softmax"]);
          const F = JSON.stringify([true, true, true]);
          net = NewNetworkFloat32(L, A, F);
          if (!net) throw new Error("failed to create network");
          setPill(netPill, "made", "ok");
          btnPerturb.disabled = btnImport.disabled = false;
          document
            .querySelectorAll("[data-digit]")
            .forEach((b) => (b.disabled = false));
          log("✅ Created network matching backend (random weights).");
        } catch (e) {
          setPill(netPill, "error", "err");
          log(e?.stack || e);
        }
      };

      // Perturb weights (optional)
      btnPerturb.onclick = () => {
        try {
          if (typeof net.PerturbWeights === "function") {
            net.PerturbWeights(argsJSON(0.05, 1337));
            setPill(wPill, "perturbed", "warn");
            log("Weights perturbed for demo.");
          }
        } catch (e) {
          log(e?.stack || e);
        }
      };

      // Import weights (from backend model JSON)
      btnImport.onclick = async () => {
        try {
          const text = await (await fetch(modelUrl.value.trim())).text();
          if (typeof net.UnmarshalJSONModel === "function") {
            net.UnmarshalJSONModel(text);
          } else if (typeof net.UnmarshalJSON === "function") {
            net.UnmarshalJSON(text);
          }
          setPill(wPill, "loaded", "ok");
          log("✅ Weights replaced from backend model.");
        } catch (e) {
          setPill(wPill, "failed", "err");
          log(e?.stack || e);
        }
      };

      function readOutput() {
        try {
          const raw = net.ExtractOutput ? net.ExtractOutput() : net.GetOutput();
          let out;
          try {
            out = JSON.parse(raw || "[]");
          } catch (parseErr) {
            console.error("JSON parse error:", parseErr);
            out = [];
          }

          // Flatten if output is nested like [[...]]
          if (Array.isArray(out) && out.length === 1 && Array.isArray(out[0])) {
            out = out[0];
          }

          if (!Array.isArray(out) || out.length !== 10) {
            console.warn(
              "Output length not 10, got",
              Array.isArray(out) ? out.length : "non-array"
            );
            return new Array(10).fill(0);
          }

          console.log("✅ Parsed output:", out);
          return out.map((x) => Number(x) || 0);
        } catch (e) {
          console.error("Output read error:", e);
          return new Array(10).fill(0);
        }
      }

      function showResult(t0) {
        try {
          const logits = readOutput();
          const probs = softmax(logits);
          const pred = probs.reduce(
            (iMax, x, i, arr) => (x > arr[iMax] ? i : iMax),
            0
          );
          predEl.textContent = String(pred);
          confEl.textContent = (Math.max(...probs) * 100).toFixed(2) + "%";
          latEl.textContent = (performance.now() - t0).toFixed(2) + " ms";
          log({
            logits: logits.map((x) => +x.toFixed(6)),
            probs: probs.map((x) => +x.toFixed(6)),
            pred,
            latency_ms: +(performance.now() - t0).toFixed(2),
          });
        } catch (e) {
          predEl.textContent = "?";
          confEl.textContent = "—";
          latEl.textContent = (performance.now() - t0).toFixed(2) + " ms";
          log({
            error: e.message,
            latency_ms: +(performance.now() - t0).toFixed(2),
          });
        }
      }

      // Run digit image from backend (process PNG to 28x28 2D)
      async function runDigit(d) {
        try {
          const url = `${svc.value.replace(/\/+$/, "")}/static/images/${d}.png`;
          const resp = await fetch(url);
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const blob = await resp.blob();
          const img = new Image();
          img.src = URL.createObjectURL(blob);
          await new Promise((resolve, reject) => {
            img.onload = resolve;
            img.onerror = () => reject(new Error("Image load failed"));
          });
          const canvas = $("canvas");
          const ctx = canvas.getContext("2d");
          ctx.drawImage(img, 0, 0, 28, 28);
          const imageData = ctx.getImageData(0, 0, 28, 28);
          const data = imageData.data;
          const img2d = [];
          for (let y = 0; y < 28; y++) {
            const row = [];
            for (let x = 0; x < 28; x++) {
              const idx = (y * 28 + x) * 4;
              const gray = data[idx] / 255.0;
              row.push(gray);
            }
            img2d.push(row);
          }
          if (img2d.length !== 28 || img2d[0].length !== 28) {
            throw new Error(
              `Invalid 2D shape: ${img2d.length}x${img2d[0]?.length || 0}`
            );
          }
          URL.revokeObjectURL(img.src);
          const t0 = performance.now();
          net.Forward(argsJSON(img2d));
          showResult(t0);
        } catch (e) {
          log(e?.stack || e);
        }
      }

      document.querySelectorAll("[data-digit]").forEach((b) => {
        b.addEventListener("click", () =>
          runDigit(b.getAttribute("data-digit"))
        );
      });
    </script>
  </body>
</html>
